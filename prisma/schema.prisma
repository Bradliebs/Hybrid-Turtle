generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                    String        @id @default(cuid())
  email                 String        @unique
  name                  String?
  password              String
  riskProfile           String        @default("BALANCED")   // CONSERVATIVE | BALANCED | SMALL_ACCOUNT
  equity                Float         @default(10000)
  // Trading 212 integration
  t212ApiKey            String?
  t212ApiSecret         String?
  t212Environment       String        @default("demo")       // demo | live
  t212Connected         Boolean       @default(false)
  t212LastSync          DateTime?
  t212AccountId         String?
  t212Currency          String?
  t212Cash              Float?
  t212Invested          Float?
  t212UnrealisedPL      Float?
  t212TotalValue        Float?
  // Trading 212 ISA account integration
  t212IsaApiKey         String?
  t212IsaApiSecret      String?
  t212IsaConnected      Boolean       @default(false)
  t212IsaLastSync       DateTime?
  t212IsaAccountId      String?
  t212IsaCurrency       String?
  t212IsaCash           Float?
  t212IsaInvested       Float?
  t212IsaUnrealisedPL   Float?
  t212IsaTotalValue     Float?
  // Market data provider — yahoo (default) or eodhd
  marketDataProvider    String        @default("yahoo")     // yahoo | eodhd
  eodhApiKey            String?                              // EODHD API key (only needed if provider=eodhd)
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  positions             Position[]
  scans                 Scan[]
  plans                 ExecutionPlan[]
  healthChecks          HealthCheck[]
  equitySnapshots        EquitySnapshot[]
  tradeLogs             TradeLog[]
}

model Stock {
  id            String       @id @default(cuid())
  ticker        String       @unique
  name          String
  sleeve        String       // CORE | HIGH_RISK | ETF | HEDGE
  sector        String?
  cluster       String?
  superCluster  String?
  region        String?      // US | UK | EUROPE | ASIA | CHINA | ETF | COMMODITY
  currency      String?      // USD | GBP | EUR | CHF | DKK | CNY
  yahooTicker   String?      // Yahoo Finance symbol override (e.g. GSK.L, SIE.DE)
  t212Ticker    String?      // Trading 212 ticker mapping e.g. AAPL_US_EQ
  isaEligible   Boolean?     // null = unknown, true = ISA eligible, false = not ISA eligible
  active        Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  positions     Position[]
  scanResults   ScanResult[]
}

model Position {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  stockId         String
  stock           Stock       @relation(fields: [stockId], references: [id])
  status          String      @default("OPEN")       // OPEN | CLOSED
  source          String      @default("manual")     // manual | trading212
  accountType     String?     @default("invest")     // invest | isa — which T212 account this position belongs to
  t212Ticker      String?                             // Original Trading 212 ticker e.g. AAPL_US_EQ
  entryPrice      Float
  entryDate       DateTime
  shares          Float
  stopLoss        Float
  initialRisk     Float
  currentStop     Float
  entry_price     Float?
  initial_stop    Float?
  initial_R       Float?
  atr_at_entry    Float?
  profile_used    String?
  entry_type      String?     @default("BREAKOUT")
  protectionLevel String      @default("INITIAL")    // INITIAL | BREAKEVEN | LOCK_08R | LOCK_1R_TRAIL
  exitPrice       Float?
  exitDate        DateTime?
  exitReason      String?     // STOP_HIT | CLIMAX_TRIM | LAGGARD_PURGE | MANUAL | RE_ENTRY_FAIL
  exitProfitR     Float?      // R-multiple at exit
  whipsawCount    Int         @default(0)            // How many times stopped out in 30 days
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  stopHistory     StopHistory[]
  tradeLogs       TradeLog[]

  @@index([userId])
  @@index([stockId])
  @@index([status])
}

model StopHistory {
  id         String   @id @default(cuid())
  positionId String
  position   Position @relation(fields: [positionId], references: [id])
  oldStop    Float
  newStop    Float
  level      String   // INITIAL | BREAKEVEN | LOCK_08R | LOCK_1R_TRAIL
  reason     String
  createdAt  DateTime @default(now())

  @@index([positionId])
}

model Scan {
  id      String       @id @default(cuid())
  userId  String
  user    User         @relation(fields: [userId], references: [id])
  runDate DateTime     @default(now())
  regime  String       // BULLISH | SIDEWAYS | BEARISH
  results ScanResult[]

  @@index([userId])
}

model ScanResult {
  id               String  @id @default(cuid())
  scanId           String
  scan             Scan    @relation(fields: [scanId], references: [id])
  stockId          String
  stock            Stock   @relation(fields: [stockId], references: [id])
  price            Float
  ma200            Float
  adx              Float
  plusDI           Float
  minusDI          Float
  atrPercent       Float
  efficiency       Float
  twentyDayHigh    Float
  entryTrigger     Float
  stopPrice        Float
  distancePercent  Float
  status           String  // READY | WATCH | FAR
  entryMode        String? // BREAKOUT | PULLBACK_CONTINUATION
  stage6Reason     String?
  rankScore        Float
  passesAllFilters Boolean
  passesRiskGates  Boolean?
  passesAntiChase  Boolean?
  shares           Float?
  riskDollars      Float?

  @@index([scanId])
  @@index([stockId])
}

model ExecutionPlan {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  weekOf     DateTime
  phase      String   // PLANNING | OBSERVATION | EXECUTION | MAINTENANCE
  candidates String   // JSON stored as string
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

model HealthCheck {
  id      String   @id @default(cuid())
  userId  String
  user    User     @relation(fields: [userId], references: [id])
  runDate DateTime @default(now())
  overall String   // GREEN | YELLOW | RED
  checks  String   // JSON stored as string
  details String   // JSON stored as string

  @@index([userId])
}

model Heartbeat {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  status    String
  details   String?  // JSON stored as string

  @@index([timestamp])
}

model TradeLog {
  id                  String    @id @default(cuid())
  userId              String
  user                User      @relation(fields: [userId], references: [id])
  positionId          String?
  position            Position? @relation(fields: [positionId], references: [id], onDelete: SetNull)

  ticker              String
  tradeDate           DateTime
  tradeType           String    // ENTRY | EXIT | ADD | TRIM | STOP_HIT

  scanStatus          String?   // READY | WATCH | TRIGGER_MET
  bqsScore            Float?
  fwsScore            Float?
  ncsScore            Float?
  dualScoreAction     String?   // AUTO_YES | AUTO_NO | CONDITIONAL
  rankScore           Float?

  entryPrice          Float?
  initialStop         Float?
  initialR            Float?
  shares              Float?
  positionSizeGbp     Float?
  atrAtEntry          Float?
  adxAtEntry          Float?
  regime              String?   // BULLISH | BEARISH | SIDEWAYS

  decision            String    // TAKEN | SKIPPED | PARTIAL
  decisionReason      String?
  hesitationLevel     Int?

  plannedEntry        Float?
  actualFill          Float?
  slippagePct         Float?
  fillTime            DateTime?

  exitPrice           Float?
  exitReason          String?   // STOP_HIT | PROFIT_TARGET | MANUAL | LAGGARD
  finalRMultiple      Float?
  gainLossGbp         Float?
  daysHeld            Int?

  whatWentWell        String?
  whatWentWrong       String?
  lessonsLearned      String?
  wouldTakeAgain      Boolean?

  climaxDetected      Boolean   @default(false)
  whipsawBlocked      Boolean   @default(false)
  breadthRestricted   Boolean   @default(false)
  antiChaseTriggered  Boolean   @default(false)

  tags                String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  @@index([userId, tradeDate(sort: Desc)])
  @@index([positionId])
  @@index([ticker])
  @@index([decision])
}

model TradeTag {
  tag         String @id
  category    String // SETUP | ERROR | MARKET_CONDITION | EXECUTION
  description String
}

model EquitySnapshot {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  equity          Float
  openRiskPercent Float?
  capturedAt      DateTime @default(now())

  @@index([userId])
  @@index([capturedAt])
}

model RegimeHistory {
  id           String   @id @default(cuid())
  date         DateTime @default(now())
  benchmark    String   @default("SPY")   // SPY | VWRL
  regime       String   // BULLISH | BEARISH | CHOP
  spyPrice     Float?
  spyMa200     Float?
  vwrlPrice    Float?
  vwrlMa200    Float?
  breadthPct   Float?   // % of universe above 50DMA
  adx          Float?
  consecutive  Int      @default(1)       // consecutive days in this regime

  @@index([date])
  @@index([benchmark])
}

// ── Dual Score Dashboard — Snapshot Ticker ──────────────────────────
// Stores per-ticker data from master_snapshot.csv, synced via upload or
// the nightly pipeline.  Scored columns (BQS/FWS/NCS) are computed at
// query time by the scoring engine so the raw data is always the source
// of truth.

model SnapshotTicker {
  id                        String   @id @default(cuid())
  snapshotId                String
  snapshot                  Snapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  // ── Identity ──
  ticker                    String
  name                      String?
  sleeve                    String?   // STOCK_CORE | ETF_CORE | STOCK_HIGH_RISK | HEDGE
  status                    String?   // READY | WATCH | FAR | IGNORE | TREND
  currency                  String?

  // ── Price & ATR ──
  close                     Float     @default(0)
  atr14                     Float     @default(0)
  atrPct                    Float     @default(0)

  // ── Trend / ADX ──
  adx14                     Float     @default(0)
  plusDi                     Float     @default(0)
  minusDi                    Float     @default(0)
  weeklyAdx                  Float     @default(0)  // ADX on weekly candles

  // ── Volume ──
  volRatio                   Float     @default(1)
  dollarVol20                Float     @default(0)
  liquidityOk                Boolean   @default(true)

  // ── Breakout Integrity Score ──
  bisScore                   Float     @default(0)  // 0–15, from latest candle OHLCV

  // ── Market regime ──
  marketRegime               String    @default("NEUTRAL")
  marketRegimeStable         Boolean   @default(true)
  volRegime                  String?   @default("NORMAL_VOL")   // LOW_VOL | NORMAL_VOL | HIGH_VOL
  dualRegimeAligned          Boolean   @default(true)           // both SPY + VWRL above MA200

  // ── Breakout levels ──
  high20                     Float     @default(0)
  high55                     Float     @default(0)
  distanceTo20dHighPct       Float     @default(0)
  distanceTo55dHighPct       Float     @default(0)
  entryTrigger               Float     @default(0)
  stopLevel                  Float     @default(0)

  // ── Chasing / volatility flags ──
  chasing20Last5             Boolean   @default(false)
  chasing55Last5             Boolean   @default(false)
  atrSpiking                 Boolean   @default(false)
  atrCollapsing              Boolean   @default(false)

  // ── Relative strength ──
  rsVsBenchmarkPct           Float     @default(0)

  // ── Earnings ──
  daysToEarnings             Int?
  earningsInNext5d           Boolean   @default(false)

  // ── Cluster / concentration ──
  clusterName                String?
  superClusterName           String?
  clusterExposurePct         Float     @default(0)
  superClusterExposurePct    Float     @default(0)
  maxClusterPct              Float     @default(0)
  maxSuperClusterPct         Float     @default(0)

  // ── Full row data (all 185 columns) stored as JSON ──
  rawJson                    String?   // JSON blob of the entire CSV row

  createdAt                  DateTime  @default(now())

  @@index([snapshotId])
  @@index([ticker])
  @@index([snapshotId, ticker])  // composite for common lookup pattern
}

model Snapshot {
  id        String            @id @default(cuid())
  source    String            @default("upload")   // upload | nightly | manual
  filename  String?
  rowCount  Int               @default(0)
  createdAt DateTime          @default(now())
  tickers   SnapshotTicker[]
}

// ── EV Tracker — Expected Value Records ─────────────────────────────
// Logs outcome data per closed trade for expectancy analysis.
// Sliced by regime, ATR bucket, cluster, and sleeve to reveal
// which setups actually produce +EV over time.
// This is logging only — no actions or alerts.

model EvRecord {
  id         String   @id @default(cuid())
  tradeId    String                         // TradeLog id that generated this record
  regime     String                         // BULLISH | SIDEWAYS | BEARISH at entry
  atrBucket  String                         // LOW | MEDIUM | HIGH | EXTREME
  cluster    String?                        // Cluster name from Stock (nullable — some tickers lack cluster)
  sleeve     String                         // CORE | HIGH_RISK | ETF | HEDGE
  entryNCS   Float?                         // Net Composite Score at entry (nullable — pre-NCS trades)
  outcome    String                         // WIN | LOSS | BREAKEVEN
  rMultiple  Float                          // Final R-multiple at exit
  closedAt   DateTime                       // When the trade was closed

  @@index([regime])
  @@index([sleeve])
  @@index([atrBucket])
  @@index([closedAt])
}

// ── Correlation Matrix — Pairwise Flags ─────────────────────────────
// Nightly-computed Pearson correlation on 90 days of daily returns.
// Pairs with correlation > 0.75 are flagged HIGH_CORR.
// Used by Module 7 (heatmap-swap) for warnings and the /risk page widget.

model CorrelationFlag {
  id            String   @id @default(cuid())
  tickerA       String                         // Alphabetically first ticker
  tickerB       String                         // Alphabetically second ticker
  correlation   Float                          // Pearson r (−1 to +1)
  flag          String                         // HIGH_CORR
  computedAt    DateTime @default(now())       // When this batch was computed

  @@unique([tickerA, tickerB])                 // One row per pair
  @@index([tickerA])
  @@index([tickerB])
  @@index([computedAt])
}

// ── Execution Log — Audit trail for T212 order execution ───────────
// Every API call to Trading 212 during buy execution is logged here.
// Covers: buy placement, fill polling, stop placement, and failures.
// This is the safety net — if anything goes wrong, we have a full record.

model ExecutionLog {
  id              Int      @id @default(autoincrement())
  createdAt       DateTime @default(now())
  ticker          String                       // Ticker being traded (Yahoo format)
  phase           String                       // BUY_PLACED | BUY_POLLING | BUY_FILLED | STOP_PLACED | BUY_TIMEOUT | STOP_FAILED | COMPLETE
  orderId         String?                      // T212 order ID (if returned)
  requestBody     String                       // JSON stringified request sent to T212
  responseStatus  Int?                         // HTTP response status code
  responseBody    String?                      // JSON stringified response from T212
  stopPrice       Float?                       // Stop price used (if applicable)
  quantity        Float?                       // Order quantity
  accountType     String                       // invest | isa
  error           String?                      // Error message if phase failed

  @@index([ticker])
  @@index([createdAt])
  @@index([phase])
}
