generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                    String        @id @default(cuid())
  email                 String        @unique
  name                  String?
  password              String
  riskProfile           String        @default("BALANCED")   // CONSERVATIVE | BALANCED | SMALL_ACCOUNT
  equity                Float         @default(10000)
  // Trading 212 integration
  t212ApiKey            String?
  t212ApiSecret         String?
  t212Environment       String        @default("demo")       // demo | live
  t212Connected         Boolean       @default(false)
  t212LastSync          DateTime?
  t212AccountId         String?
  t212Currency          String?
  t212Cash              Float?
  t212Invested          Float?
  t212UnrealisedPL      Float?
  t212TotalValue        Float?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt
  positions             Position[]
  scans                 Scan[]
  plans                 ExecutionPlan[]
  healthChecks          HealthCheck[]
  equitySnapshots        EquitySnapshot[]
}

model Stock {
  id            String       @id @default(cuid())
  ticker        String       @unique
  name          String
  sleeve        String       // CORE | HIGH_RISK | ETF | HEDGE
  sector        String?
  cluster       String?
  superCluster  String?
  region        String?      // US | UK | EUROPE | ASIA | CHINA | ETF | COMMODITY
  currency      String?      // USD | GBP | EUR | CHF | DKK | CNY
  t212Ticker    String?      // Trading 212 ticker mapping e.g. AAPL_US_EQ
  active        Boolean      @default(true)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt
  positions     Position[]
  scanResults   ScanResult[]
}

model Position {
  id              String      @id @default(cuid())
  userId          String
  user            User        @relation(fields: [userId], references: [id])
  stockId         String
  stock           Stock       @relation(fields: [stockId], references: [id])
  status          String      @default("OPEN")       // OPEN | CLOSED
  source          String      @default("manual")     // manual | trading212
  t212Ticker      String?                             // Original Trading 212 ticker e.g. AAPL_US_EQ
  entryPrice      Float
  entryDate       DateTime
  shares          Float
  stopLoss        Float
  initialRisk     Float
  currentStop     Float
  protectionLevel String      @default("INITIAL")    // INITIAL | BREAKEVEN | LOCK_08R | LOCK_1R_TRAIL
  exitPrice       Float?
  exitDate        DateTime?
  exitReason      String?     // STOP_HIT | CLIMAX_TRIM | LAGGARD_PURGE | MANUAL | RE_ENTRY_FAIL
  exitProfitR     Float?      // R-multiple at exit
  whipsawCount    Int         @default(0)            // How many times stopped out in 30 days
  notes           String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  stopHistory     StopHistory[]
  tradeLogs       TradeLog[]

  @@index([userId])
  @@index([stockId])
  @@index([status])
}

model StopHistory {
  id         String   @id @default(cuid())
  positionId String
  position   Position @relation(fields: [positionId], references: [id])
  oldStop    Float
  newStop    Float
  level      String   // INITIAL | BREAKEVEN | LOCK_08R | LOCK_1R_TRAIL
  reason     String
  createdAt  DateTime @default(now())

  @@index([positionId])
}

model Scan {
  id      String       @id @default(cuid())
  userId  String
  user    User         @relation(fields: [userId], references: [id])
  runDate DateTime     @default(now())
  regime  String       // BULLISH | SIDEWAYS | BEARISH
  results ScanResult[]

  @@index([userId])
}

model ScanResult {
  id               String  @id @default(cuid())
  scanId           String
  scan             Scan    @relation(fields: [scanId], references: [id])
  stockId          String
  stock            Stock   @relation(fields: [stockId], references: [id])
  price            Float
  ma200            Float
  adx              Float
  plusDI           Float
  minusDI          Float
  atrPercent       Float
  efficiency       Float
  twentyDayHigh    Float
  entryTrigger     Float
  stopPrice        Float
  distancePercent  Float
  status           String  // READY | WATCH | FAR
  rankScore        Float
  passesAllFilters Boolean
  shares           Int?
  riskDollars      Float?

  @@index([scanId])
  @@index([stockId])
}

model ExecutionPlan {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  weekOf     DateTime
  phase      String   // PLANNING | OBSERVATION | EXECUTION | MAINTENANCE
  candidates String   // JSON stored as string
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([userId])
}

model HealthCheck {
  id      String   @id @default(cuid())
  userId  String
  user    User     @relation(fields: [userId], references: [id])
  runDate DateTime @default(now())
  overall String   // GREEN | YELLOW | RED
  checks  String   // JSON stored as string
  details String   // JSON stored as string

  @@index([userId])
}

model Heartbeat {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  status    String
  details   String?  // JSON stored as string
}

model TradeLog {
  id              String   @id @default(cuid())
  positionId      String
  position        Position @relation(fields: [positionId], references: [id])
  userId          String
  ticker          String
  action          String   // BUY | SELL | TRIM
  expectedPrice   Float
  actualPrice     Float?
  slippagePercent Float?
  shares          Float
  reason          String?  // ENTRY | STOP_HIT | CLIMAX_TRIM | LAGGARD_PURGE | RE_ENTRY | MANUAL
  rMultipleAtExit Float?
  createdAt       DateTime @default(now())

  @@index([positionId])
  @@index([userId])
  @@index([ticker])
}

model EquitySnapshot {
  id              String   @id @default(cuid())
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  equity          Float
  openRiskPercent Float?
  capturedAt      DateTime @default(now())

  @@index([userId])
  @@index([capturedAt])
}

model RegimeHistory {
  id           String   @id @default(cuid())
  date         DateTime @default(now())
  benchmark    String   @default("SPY")   // SPY | VWRL
  regime       String   // BULLISH | BEARISH | CHOP
  spyPrice     Float?
  spyMa200     Float?
  vwrlPrice    Float?
  vwrlMa200    Float?
  breadthPct   Float?   // % of universe above 50DMA
  adx          Float?
  consecutive  Int      @default(1)       // consecutive days in this regime

  @@index([date])
  @@index([benchmark])
}

// ── Dual Score Dashboard — Snapshot Ticker ──────────────────────────
// Stores per-ticker data from master_snapshot.csv, synced via upload or
// the nightly pipeline.  Scored columns (BQS/FWS/NCS) are computed at
// query time by the scoring engine so the raw data is always the source
// of truth.

model SnapshotTicker {
  id                        String   @id @default(cuid())
  snapshotId                String
  snapshot                  Snapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  // ── Identity ──
  ticker                    String
  name                      String?
  sleeve                    String?   // STOCK_CORE | ETF_CORE | STOCK_HIGH_RISK | HEDGE
  status                    String?   // READY | WATCH | FAR | IGNORE | TREND
  currency                  String?

  // ── Price & ATR ──
  close                     Float     @default(0)
  atr14                     Float     @default(0)
  atrPct                    Float     @default(0)

  // ── Trend / ADX ──
  adx14                     Float     @default(0)
  plusDi                     Float     @default(0)
  minusDi                    Float     @default(0)

  // ── Volume ──
  volRatio                   Float     @default(1)
  dollarVol20                Float     @default(0)
  liquidityOk                Boolean   @default(true)

  // ── Market regime ──
  marketRegime               String    @default("NEUTRAL")
  marketRegimeStable         Boolean   @default(true)

  // ── Breakout levels ──
  high20                     Float     @default(0)
  high55                     Float     @default(0)
  distanceTo20dHighPct       Float     @default(0)
  distanceTo55dHighPct       Float     @default(0)
  entryTrigger               Float     @default(0)
  stopLevel                  Float     @default(0)

  // ── Chasing / volatility flags ──
  chasing20Last5             Boolean   @default(false)
  chasing55Last5             Boolean   @default(false)
  atrSpiking                 Boolean   @default(false)
  atrCollapsing              Boolean   @default(false)

  // ── Relative strength ──
  rsVsBenchmarkPct           Float     @default(0)

  // ── Earnings ──
  daysToEarnings             Int?
  earningsInNext5d           Boolean   @default(false)

  // ── Cluster / concentration ──
  clusterName                String?
  superClusterName           String?
  clusterExposurePct         Float     @default(0)
  superClusterExposurePct    Float     @default(0)
  maxClusterPct              Float     @default(0)
  maxSuperClusterPct         Float     @default(0)

  // ── Full row data (all 185 columns) stored as JSON ──
  rawJson                    String?   // JSON blob of the entire CSV row

  createdAt                  DateTime  @default(now())

  @@index([snapshotId])
  @@index([ticker])
}

model Snapshot {
  id        String            @id @default(cuid())
  source    String            @default("upload")   // upload | nightly | manual
  filename  String?
  rowCount  Int               @default(0)
  createdAt DateTime          @default(now())
  tickers   SnapshotTicker[]
}
