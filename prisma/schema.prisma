generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id                  String           @id @default(cuid())
  email               String           @unique
  name                String?
  password            String
  riskProfile         String           @default("BALANCED")
  equity              Float            @default(10000)
  t212ApiKey          String?
  t212ApiSecret       String?
  t212Environment     String           @default("demo")
  t212Connected       Boolean          @default(false)
  t212LastSync        DateTime?
  t212AccountId       String?
  t212Currency        String?
  t212Cash            Float?
  t212Invested        Float?
  t212UnrealisedPL    Float?
  t212TotalValue      Float?
  t212IsaApiKey       String?
  t212IsaApiSecret    String?
  t212IsaConnected    Boolean          @default(false)
  t212IsaLastSync     DateTime?
  t212IsaAccountId    String?
  t212IsaCurrency     String?
  t212IsaCash         Float?
  t212IsaInvested     Float?
  t212IsaUnrealisedPL Float?
  t212IsaTotalValue   Float?
  marketDataProvider  String           @default("yahoo")
  eodhApiKey          String?
  gapGuardMode        String           @default("ALL")
  gapGuardWeekendATR  Float            @default(0.75)
  gapGuardWeekendPct  Float            @default(3.0)
  gapGuardDailyATR    Float            @default(1.0)
  gapGuardDailyPct    Float            @default(4.0)
  createdAt           DateTime         @default(now())
  updatedAt           DateTime         @updatedAt
  equitySnapshots     EquitySnapshot[]
  plans               ExecutionPlan[]
  healthChecks        HealthCheck[]
  positions           Position[]
  scans               Scan[]
  tradeLogs           TradeLog[]
}

model Stock {
  id           String       @id @default(cuid())
  ticker       String       @unique
  name         String
  sleeve       String
  sector       String?
  cluster      String?
  superCluster String?
  region       String?
  currency     String?
  t212Ticker   String?
  active       Boolean      @default(true)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  yahooTicker  String?
  isaEligible  Boolean?
  positions    Position[]
  scanResults  ScanResult[]
}

model Position {
  id                        String        @id @default(cuid())
  userId                    String
  stockId                   String
  status                    String        @default("OPEN")
  source                    String        @default("manual")
  t212Ticker                String?
  entryPrice                Float
  entryDate                 DateTime
  shares                    Float
  stopLoss                  Float
  initialRisk               Float
  currentStop               Float
  protectionLevel           String        @default("INITIAL")
  exitPrice                 Float?
  exitDate                  DateTime?
  exitReason                String?
  exitProfitR               Float?
  whipsawCount              Int           @default(0)
  notes                     String?
  createdAt                 DateTime      @default(now())
  updatedAt                 DateTime      @updatedAt
  atr_at_entry              Float?
  entry_price               Float?
  entry_type                String?       @default("BREAKOUT")
  initial_R                 Float?
  initial_stop              Float?
  profile_used              String?
  accountType               String?       @default("invest")
  breakoutFailureDetectedAt DateTime?
  entryTrigger              Float?
  stock                     Stock         @relation(fields: [stockId], references: [id])
  user                      User          @relation(fields: [userId], references: [id])
  stopHistory               StopHistory[]
  tradeLogs                 TradeLog[]
  journal                   TradeJournal?

  @@index([userId])
  @@index([stockId])
  @@index([status])
}

model StopHistory {
  id         String   @id @default(cuid())
  positionId String
  oldStop    Float
  newStop    Float
  level      String
  reason     String
  createdAt  DateTime @default(now())
  position   Position @relation(fields: [positionId], references: [id])

  @@index([positionId])
}

model Scan {
  id      String       @id @default(cuid())
  userId  String
  runDate DateTime     @default(now())
  regime  String
  user    User         @relation(fields: [userId], references: [id])
  results ScanResult[]

  @@index([userId])
}

model ScanResult {
  id               String   @id @default(cuid())
  scanId           String
  stockId          String
  price            Float
  ma200            Float
  adx              Float
  plusDI           Float
  minusDI          Float
  atrPercent       Float
  efficiency       Float
  twentyDayHigh    Float
  entryTrigger     Float
  stopPrice        Float
  distancePercent  Float
  status           String
  entryMode        String?
  stage6Reason     String?
  rankScore        Float
  passesAllFilters Boolean
  passesRiskGates  Boolean?
  passesAntiChase  Boolean?
  shares           Float?
  riskDollars      Float?
  stock            Stock    @relation(fields: [stockId], references: [id])
  scan             Scan     @relation(fields: [scanId], references: [id])

  @@index([scanId])
  @@index([stockId])
}

model ExecutionPlan {
  id         String   @id @default(cuid())
  userId     String
  weekOf     DateTime
  phase      String
  candidates String
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  user       User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model HealthCheck {
  id      String   @id @default(cuid())
  userId  String
  runDate DateTime @default(now())
  overall String
  checks  String
  details String
  user    User     @relation(fields: [userId], references: [id])

  @@index([userId])
}

model Heartbeat {
  id        String   @id @default(cuid())
  timestamp DateTime @default(now())
  status    String
  details   String?

  @@index([timestamp])
}

model TradeLog {
  id                 String    @id @default(cuid())
  userId             String
  positionId         String?
  ticker             String
  tradeDate          DateTime
  tradeType          String
  scanStatus         String?
  bqsScore           Float?
  fwsScore           Float?
  ncsScore           Float?
  dualScoreAction    String?
  rankScore          Float?
  entryPrice         Float?
  initialStop        Float?
  initialR           Float?
  shares             Float?
  positionSizeGbp    Float?
  atrAtEntry         Float?
  adxAtEntry         Float?
  regime             String?
  decision           String
  decisionReason     String?
  hesitationLevel    Int?
  plannedEntry       Float?
  actualFill         Float?
  slippagePct        Float?
  fillTime           DateTime?
  exitPrice          Float?
  exitReason         String?
  finalRMultiple     Float?
  gainLossGbp        Float?
  daysHeld           Int?
  whatWentWell       String?
  whatWentWrong      String?
  lessonsLearned     String?
  wouldTakeAgain     Boolean?
  climaxDetected     Boolean   @default(false)
  whipsawBlocked     Boolean   @default(false)
  breadthRestricted  Boolean   @default(false)
  antiChaseTriggered Boolean   @default(false)
  tags               String?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt
  position           Position? @relation(fields: [positionId], references: [id])
  user               User      @relation(fields: [userId], references: [id])

  @@index([userId, tradeDate(sort: Desc)])
  @@index([positionId])
  @@index([ticker])
  @@index([decision])
}

model TradeTag {
  tag         String @id
  category    String
  description String
}

model EquitySnapshot {
  id              String   @id @default(cuid())
  userId          String
  equity          Float
  openRiskPercent Float?
  capturedAt      DateTime @default(now())
  user            User     @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([capturedAt])
}

model RegimeHistory {
  id          String   @id @default(cuid())
  date        DateTime @default(now())
  benchmark   String   @default("SPY")
  regime      String
  spyPrice    Float?
  spyMa200    Float?
  vwrlPrice   Float?
  vwrlMa200   Float?
  breadthPct  Float?
  adx         Float?
  consecutive Int      @default(1)

  @@index([date])
  @@index([benchmark])
}

model SnapshotTicker {
  id                      String   @id @default(cuid())
  snapshotId              String
  ticker                  String
  name                    String?
  sleeve                  String?
  status                  String?
  currency                String?
  close                   Float    @default(0)
  atr14                   Float    @default(0)
  atrPct                  Float    @default(0)
  adx14                   Float    @default(0)
  plusDi                  Float    @default(0)
  minusDi                 Float    @default(0)
  weeklyAdx               Float    @default(0)
  volRatio                Float    @default(1)
  dollarVol20             Float    @default(0)
  liquidityOk             Boolean  @default(true)
  bisScore                Float    @default(0)
  marketRegime            String   @default("NEUTRAL")
  marketRegimeStable      Boolean  @default(true)
  volRegime               String?  @default("NORMAL_VOL")
  dualRegimeAligned       Boolean  @default(true)
  high20                  Float    @default(0)
  high55                  Float    @default(0)
  distanceTo20dHighPct    Float    @default(0)
  distanceTo55dHighPct    Float    @default(0)
  entryTrigger            Float    @default(0)
  stopLevel               Float    @default(0)
  chasing20Last5          Boolean  @default(false)
  chasing55Last5          Boolean  @default(false)
  atrSpiking              Boolean  @default(false)
  atrCollapsing           Boolean  @default(false)
  rsVsBenchmarkPct        Float    @default(0)
  daysToEarnings          Int?
  earningsInNext5d        Boolean  @default(false)
  clusterName             String?
  superClusterName        String?
  clusterExposurePct      Float    @default(0)
  superClusterExposurePct Float    @default(0)
  maxClusterPct           Float    @default(0)
  maxSuperClusterPct      Float    @default(0)
  rawJson                 String?
  createdAt               DateTime @default(now())
  atrCompressionRatio     Float?
  snapshot                Snapshot @relation(fields: [snapshotId], references: [id], onDelete: Cascade)

  @@index([snapshotId])
  @@index([ticker])
  @@index([snapshotId, ticker])
}

model Snapshot {
  id        String           @id @default(cuid())
  source    String           @default("upload")
  filename  String?
  rowCount  Int              @default(0)
  createdAt DateTime         @default(now())
  tickers   SnapshotTicker[]
}

model EvRecord {
  id        String   @id @default(cuid())
  tradeId   String
  regime    String
  atrBucket String
  cluster   String?
  sleeve    String
  entryNCS  Float?
  outcome   String
  rMultiple Float
  closedAt  DateTime

  @@index([regime])
  @@index([sleeve])
  @@index([atrBucket])
  @@index([closedAt])
}

model CorrelationFlag {
  id          String   @id @default(cuid())
  tickerA     String
  tickerB     String
  correlation Float
  flag        String
  computedAt  DateTime @default(now())

  @@unique([tickerA, tickerB])
  @@index([tickerA])
  @@index([tickerB])
  @@index([computedAt])
}

model ExecutionLog {
  id             Int      @id @default(autoincrement())
  createdAt      DateTime @default(now())
  ticker         String
  phase          String
  orderId        String?
  requestBody    String
  responseStatus Int?
  responseBody   String?
  stopPrice      Float?
  quantity       Float?
  accountType    String
  error          String?

  @@index([ticker])
  @@index([createdAt])
  @@index([phase])
}

model Notification {
  id        Int       @id @default(autoincrement())
  createdAt DateTime  @default(now())
  readAt    DateTime?
  type      String
  title     String
  message   String
  data      String?
  priority  String    @default("INFO")

  @@index([readAt])
  @@index([createdAt])
  @@index([type])
}

model EarningsCache {
  id               Int       @id @default(autoincrement())
  ticker           String    @unique
  nextEarningsDate DateTime?
  confidence       String    @default("NONE")
  fetchedAt        DateTime  @default(now())
  source           String    @default("YAHOO")

  @@index([ticker])
  @@index([fetchedAt])
}

model TradeJournal {
  id              Int       @id @default(autoincrement())
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  positionId      String    @unique
  position        Position  @relation(fields: [positionId], references: [id])
  entryNote       String?
  entryConfidence Int?
  closeNote       String?
  learnedNote     String?
  entryNoteAt     DateTime?
  closeNoteAt     DateTime?
}
